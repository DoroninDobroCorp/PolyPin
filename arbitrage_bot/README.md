# Арбитражный бот для Pinnacle и Polymarket

Этот проект представляет собой автоматизированного бота для поиска и использования арбитражных возможностей на рынках лайв-спортивных событий между букмекером Pinnacle и биржей Polymarket.

## Ключевые технологии

- **Парсер Pinnacle:** Приложение на **Go**, которое парсит лайв-события с Pinnacle и транслирует их по WebSocket.
- **Арбитражный бот:** Основное приложение на **Python**, использующее `asyncio` для асинхронной обработки данных.
- **Взаимодействие с Polymarket:**
  - Получение данных: через HTTP-запросы к публичному API (`httpx`).
  - Совершение сделок: через библиотеку `py-clob-client` для взаимодействия с биржей.
- **Коммуникация:** Обмен данными между парсером и ботом происходит через `websockets`.

## Как это работает

1. **Поток данных от Pinnacle:** Go-парсер (`data/parse_serge`) непрерывно собирает данные о лайв-матчах и их коэффициентах, отправляя их в виде JSON-сообщений на WebSocket-сервер `ws://localhost:8765`.
2. **Поток данных от Polymarket:** Python-бот (`arbitrage_bot/main.py`) асинхронно и непрерывно опрашивает API Polymarket, получая актуальный список лайв-событий и их текущие цены.
3. **Сопоставление событий:** Бот сравнивает названия матчей из Pinnacle с названиями из Polymarket, используя нечеткое сравнение строк (`thefuzz`), чтобы найти соответствия.
4. **Поиск арбитража:** Для каждого совпавшего матча бот сравнивает коэффициенты. Если коэффициент на Polymarket на **12% или более** выгоднее, чем на Pinnacle, это считается арбитражной возможностью.
5. **Исполнение сделки:** При нахождении возможности бот автоматически формирует и отправляет ордер на покупку на биржу Polymarket, используя ваш приватный ключ и `py-clob-client`.
6. **Детальное логирование:** Каждая успешная сделка запускает механизм логирования, который сохраняет полную картину рынка (все котировки) за `60 секунд до` и `120 секунд после` сделки в отдельный JSON-файл.

## Структура проекта

```tree
../
├── arbitrage_bot/            # Основной Python-бот (пакет)
│   ├── main.py               # Точка входа (обвязка)
│   ├── strategy.py           # Основная арбитражная логика
│   ├── data_sources.py       # Интеграция с Pinnacle и Polymarket
│   ├── trading.py            # Исполнение сделок, cooldown, paper-мод
│   ├── matching.py           # Сопоставление матчей и ручное подтверждение
│   ├── config.py             # Конфигурация и работа с .env
│   ├── match_registry/       # Файлы для ручного подтверждения матчей
│   ├── trade_logs/           # Папка для детальных логов сделок (создается автоматически)
│   └── data_cache/           # Снапшоты входящих данных (для отладки)
│
├── data/
│   └── parse_serge/          # Go-парсер для Pinnacle
│       ├── cmd/main.go       # Точка входа парсера
│       └── configs/common.yml # Конфигурация парсера
│
└── specification.md          # Техническое задание
```

## Установка и запуск

### Шаг 1: Настройка и запуск парсера Pinnacle

1. **Перейдите в директорию парсера:**

    ```bash
    cd data/parse_serge
    ```

2. **Убедитесь, что конфигурация верна:**
    Откройте `configs/common.yml`. Самое важное — чтобы `sender.url` указывал на WebSocket-сервер нашего бота:

    ```yaml
    sender:
      url: ws://localhost:8765
    ```

3. **Установите зависимости Go:**

    ```bash
    go mod tidy
    ```

4. **Запустите парсер (в отдельном терминале):**

    ```bash
    go run cmd/main.go
    ```

    После запуска вы должны увидеть логи о том, что парсер начал работу.

### Шаг 2: Настройка и запуск арбитражного бота

1. **Перейдите в директорию бота:**

    ```bash
    cd arbitrage_bot
    ```

2. **Создайте и активируйте виртуальное окружение:**

    ```bash
    python -m venv .venv
    source .venv/bin/activate
    ```

3. **Установите зависимости Python:**

    ```bash
    pip install -r requirements.txt
    ```

4. **Настройте учетные данные (ВАЖНО!):**

    ```bash
    cp .env.example .env
    ```

    Отредактируйте `.env`, указав приватный ключ и дополнительные параметры (при необходимости `POLY_SIGNATURE_TYPE`, `POLY_PROXY_ADDRESS`, `SELL_MODE` и т.д.).

5. **Запустите бота (во втором терминале):**

    ```bash
    python -m arbitrage_bot.main
    ```

    Запуск через модуль гарантирует корректную работу относительных импортов.

Теперь бот запущен и слушает данные от парсера, одновременно опрашивая Polymarket.

## Ключевые нюансы и особенности

### Тестовый режим (`TEST_MODE`)

Флаг `TEST_MODE` читается из `.env`.

- **`TEST_MODE = true`**: В этом режиме бот игнорирует реальные данные от Pinnacle. Вместо этого он берёт **реальные** данные с Polymarket и на их основе **динамически генерирует** поддельное событие Pinnacle с таким коэффициентом, чтобы гарантированно создать **исполнимую** арбитражную возможность. Это мощный инструмент для проверки всей цепочки без ожидания реального сигнала.
- **`TEST_MODE = false`**: Боевой режим. Бот работает с реальными данными с обеих платформ.

### Сопоставление рынков и ручное подтверждение

- **Поиск совпадений:** Используется `thefuzz` для первичного сопоставления названий. Порог схожести — 70.
- **Ручное подтверждение:** Каждое новое соответствие Pinnacle ↔ Polymarket записывается в `match_registry/pending_matches.csv`. При работе бота в консоли появится интерактивный запрос: `y` — добавить в `approved_matches.json`, `n` — отклонить, `Enter`/`s` — отложить (спросим снова через 30 секунд). Пример структуры файла — `match_registry/approved_matches.sample.json`.
- **Выбор нужного рынка (moneyline):** Сначала ищем явный `sportsMarketType == "moneyline"`. Если его нет, используем дополнительное нечеткое сравнение вопросов рынка и названия матча. При отсутствии явного moneyline бот собирает его из бинарных рынков победы/ничьи/поражения.

### Защита от повторных сделок

Функция `check_trade_cooldown` реализует правило ТЗ: бот не будет совершать повторную сделку на тот же исход в течение 2 минут, если цена на Polymarket не стала лучше, чем в прошлый раз (учитываются также "минимальные" отказы биржи, чтобы не спамить ордерами).

### Детальное логирование `T-60s / T+120s`

Это ключевая особенность для анализа. При совершении каждой сделки бот автоматически сохраняет в папку `trade_logs` подробный JSON-файл. В нем содержится:

- Детали самой сделки.
- "Слепок" всех котировок от Pinnacle и Polymarket за 60 секунд **до** сделки.
- "Слепок" всех котировок за 120 секунд **после** сделки.

Это позволяет в точности восстановить рыночную ситуацию вокруг каждого арбитражного случая. Бот также обеспечивает "вежливое" завершение работы (`Ctrl+C`), дожидаясь сохранения всех логов, которые находятся в процессе записи.
