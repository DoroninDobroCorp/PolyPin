# Арбитражный бот для Pinnacle и Polymarket

Этот проект представляет собой автоматизированного бота для поиска и использования арбитражных возможностей на рынках лайв-спортивных событий между букмекером Pinnacle и биржей Polymarket.

## Ключевые технологии

- **Парсер Pinnacle:** Приложение на **Go**, которое парсит лайв-события с Pinnacle и транслирует их по WebSocket.
- **Арбитражный бот:** Основное приложение на **Python**, использующее `asyncio` для асинхронной обработки данных.
- **Взаимодействие с Polymarket:**
  - Получение данных: через HTTP-запросы к публичному API (`httpx`).
  - Совершение сделок: через библиотеку `py-clob-client` для взаимодействия с биржей.
- **Коммуникация:** Обмен данными между парсером и ботом происходит через `websockets`.

## Как это работает

1. **Поток данных от Pinnacle:** Go-парсер (`data/parse_serge`) непрерывно собирает данные о лайв-матчах и их коэффициентах, отправляя их в виде JSON-сообщений на WebSocket-сервер `ws://localhost:8765`.
2. **Поток данных от Polymarket:** Python-бот (`arbitrage_bot/main.py`) асинхронно и непрерывно опрашивает API Polymarket, получая актуальный список лайв-событий и их текущие цены.
3. **Сопоставление событий:** Бот сравнивает названия матчей из Pinnacle с названиями из Polymarket, используя нечеткое сравнение строк (`thefuzz`), чтобы найти соответствия.
4. **Поиск арбитража:** Для каждого совпавшего матча бот сравнивает коэффициенты. Если коэффициент на Polymarket на **12% или более** выгоднее, чем на Pinnacle, это считается арбитражной возможностью.
5. **Исполнение сделки:** При нахождении возможности бот автоматически формирует и отправляет ордер на покупку на биржу Polymarket, используя ваш приватный ключ и `py-clob-client`.
6. **Детальное логирование:** Каждая успешная сделка запускает механизм логирования, который сохраняет полную картину рынка (все котировки) за `60 секунд до` и `120 секунд после` сделки в отдельный JSON-файл.

## Структура проекта

```tree
../
├── arbitrage_bot/            # Основной Python-бот
│   ├── main.py               # Вся логика бота
│   ├── requirements.txt      # Зависимости Python
│   └── trade_logs/           # Папка для детальных логов сделок (создается автоматически)
│
├── data/
│   └── parse_serge/          # Go-парсер для Pinnacle
│       ├── cmd/main.go       # Точка входа парсера
│       └── configs/common.yml # Конфигурация парсера
│
└── specification.md          # Техническое задание
```

## Установка и запуск

### Шаг 1: Настройка и запуск парсера Pinnacle

1. **Перейдите в директорию парсера:**

    ```bash
    cd data/parse_serge
    ```

2. **Убедитесь, что конфигурация верна:**
    Откройте `configs/common.yml`. Самое важное — чтобы `sender.url` указывал на WebSocket-сервер нашего бота:

    ```yaml
    sender:
      url: ws://localhost:8765
    ```

3. **Установите зависимости Go:**

    ```bash
    go mod tidy
    ```

4. **Запустите парсер (в отдельном терминале):**

    ```bash
    go run cmd/main.go
    ```

    После запуска вы должны увидеть логи о том, что парсер начал работу.

### Шаг 2: Настройка и запуск арбитражного бота

1. **Перейдите в директорию бота:**

    ```bash
    cd arbitrage_bot
    ```

2. **Создайте и активируйте виртуальное окружение:**

    ```bash
    python -m venv .venv
    source .venv/bin/activate
    ```

3. **Установите зависимости Python:**

    ```bash
    pip install -r requirements.txt
    ```

4. **Настройте учетные данные (ВАЖНО!):**
    Откройте файл `arbitrage_bot/main.py` и найдите секцию `Polymarket Client Configuration`. Заполните следующие поля:
    - `PRIVATE_KEY`: Ваш приватный ключ от кошелька, который вы используете для Polymarket.
    - `FUNDER_ADDRESS`: Адрес вашего "умного кошелька" на Polymarket, на который вы пополняете USDC.

5. **Запустите бота (во втором терминале):**

    ```bash
    python main.py
    ```

Теперь бот запущен и слушает данные от парсера, одновременно опрашивая Polymarket.

## Ключевые нюансы и особенности

### Тестовый режим (`TEST_MODE`)

В `main.py` есть флаг `TEST_MODE`.

- **`TEST_MODE = True`**: В этом режиме бот игнорирует реальные данные от Pinnacle. Вместо этого он берет **реальные** данные с Polymarket и на их основе **динамически генерирует** поддельное событие Pinnacle с таким коэффициентом, чтобы гарантированно создать **исполнимую** арбитражную возможность. Это мощнейший инструмент для проверки всей цепочки (от поиска до реальной сделки) без необходимости ждать удачного стечения обстоятельств на рынке.
- **`TEST_MODE = False`**: Боевой режим. Бот работает с реальными данными с обеих платформ.

### Сопоставление рынков

- **Сопоставление матчей:** Происходит в функции `find_matching_polymarket_event` с помощью `fuzz.token_sort_ratio`. Порог схожести установлен на `80%`. Если матчи не находятся, возможно, этот порог стоит немного понизить.
- **Выбор нужного рынка (Moneyline):** В одном событии Polymarket может быть несколько рынков (победа, тотал, фора). Функция `find_polymarket_moneyline_market` надежно находит именно рынок на чистую победу, сначала по специальному флагу `sportsMarketType: "moneyline"`, а если его нет — по степени схожести названия матча и вопроса рынка.

### Защита от повторных сделок

Функция `check_trade_cooldown` реализует важное правило из ТЗ: бот не будет совершать повторную сделку на тот же исход в течение 2 минут, если цена на Polymarket не стала лучше, чем в прошлый раз.

### Детальное логирование `T-60s / T+120s`

Это ключевая особенность для анализа. При совершении каждой сделки бот автоматически сохраняет в папку `trade_logs` подробный JSON-файл. В нем содержится:

- Детали самой сделки.
- "Слепок" всех котировок от Pinnacle и Polymarket за 60 секунд **до** сделки.
- "Слепок" всех котировок за 120 секунд **после** сделки.

Это позволяет в точности восстановить рыночную ситуацию вокруг каждого арбитражного случая. Бот также обеспечивает "вежливое" завершение работы (`Ctrl+C`), дожидаясь сохранения всех логов, которые находятся в процессе записи.
